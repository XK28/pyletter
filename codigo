import os
from openpyxl import load_workbook
from docx import Document


def replace_run_text(paragraph, placeholder, value):
    for run in paragraph.runs:
        if placeholder in run.text:
            run.text = run.text.replace(placeholder, value)


TEMPLATE_PATH = r"E:\VS\Python\template.docx"
EXCEL_PATH = r"E:\VS\Python\data.xlsx"
OUTPUT_DIR = r"E:\VS\Python\output_letters"
os.makedirs(OUTPUT_DIR, exist_ok=True)

wb = load_workbook(EXCEL_PATH)
sheet = wb.active
headers = [cell.value for cell in sheet[1]]

for row in sheet.iter_rows(min_row=2, values_only=True):
    data = dict(zip(headers, row))
    doc = Document(TEMPLATE_PATH)

    for para in doc.paragraphs:
        for key, val in data.items():
            replace_run_text(para, f"<{key}>", str(val))

    for table in doc.tables:
        for cell in table._cells:
            for key, val in data.items():
                replace_run_text(cell, f"<{key}>", str(val))

    safe = "_".join(str(data.get(k, '')).strip()
                    for k in ('nombre', 'apellido'))
    fname = f"Letter_{safe or 'output'}.docx"
    doc.save(os.path.join(OUTPUT_DIR, fname))

print("Documentos generados.")
