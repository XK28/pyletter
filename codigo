import os
from openpyxl import load_workbook
from docx import Document

# Ajusta estas rutas según tu sistema
TEMPLATE_PATH = 'template.docx'
EXCEL_PATH = 'data.xlsx'
OUTPUT_DIR = 'output_letters'

os.makedirs(OUTPUT_DIR, exist_ok=True)

# Cargar Excel
wb = load_workbook(EXCEL_PATH)
sheet = wb.active

# Leer encabezados de la primera fila
headers = [cell.value for cell in sheet[1]]

# Iterar filas desde la segunda
for row in sheet.iter_rows(min_row=2, values_only=True):
    data = dict(zip(headers, row))
    
    # Cargar plantilla Word
    doc = Document(TEMPLATE_PATH)
    
    # Reemplazar placeholders en párrafos
    for para in doc.paragraphs:
        for key, val in data.items():
            placeholder = f"<{key}>"
            if placeholder in para.text:
                para.text = para.text.replace(placeholder, str(val))
    
    # También puedes reemplazar dentro de tablas si hace falta
    for table in doc.tables:
        for cell in table._cells:
            for key, val in data.items():
                placeholder = f"<{key}>"
                if placeholder in cell.text:
                    cell.text = cell.text.replace(placeholder, str(val))
    
    # Guardar documento personalizado
    name_safe = str(data.get('Name', 'output')).replace(' ', '_')
    output_path = os.path.join(OUTPUT_DIR, f"Letter_{name_safe}.docx")
    doc.save(output_path)

print("Todos los documentos han sido generados con éxito.")
